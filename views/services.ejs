<%- include('partials/header') %>

<div class="d-flex justify-content-between align-items-center mb-3">
    <h1>Services Calendar</h1>
    <a href="/services/add" class="btn btn-primary">Create New Service</a>
</div>

<div id="calendar"></div>

<script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.js"></script>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const calendarEl = document.getElementById('calendar');
        const calendar = new FullCalendar.Calendar(calendarEl, {
            initialView: 'dayGridMonth',
            headerToolbar: {
                left: 'prev,next today',
                center: 'title',
                right: 'dayGridMonth,timeGridWeek'
            },
            events: <%- JSON.stringify(services.map(s => ({
                title: s.topic,
                start: s.serviceDateTime,
                extendedProps: {
                    _id: s._id
                }
            }))) %>,
            eventClick: function(info) {
                window.location.href = `/services/${info.event.extendedProps._id}`;
            },
            editable: true,
            eventDrop: function(info) {
                const serviceId = info.event.extendedProps._id;
                const newDate = info.event.start;

                fetch(`/services/update-date`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ serviceId, newDate })
                })
                .then(response => response.json())
                .then(data => {
                    if (!data.success) {
                        alert('Failed to update service date.');
                        info.revert();
                    }
                })
                .catch(err => {
                    console.error('Error updating service date:', err);
                    info.revert();
                });
            }
        });
        calendar.render();
    });
</script>

<%- include('partials/footer') %>
