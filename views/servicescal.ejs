<%- include('partials/header') %>

<div class="d-flex justify-content-between align-items-center mb-3">
    <h1>Services Calendar</h1>
    <a href="/services/add" class="btn btn-primary">Create New Service</a>
</div>


<div id="calendar" aria-label="Services Calendar" role="region"></div>
<%- JSON.stringify(services) %> 
<script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.js"></script> 
<script>

    // Expose server-side data as a JS variable
    var servicesData = <%- JSON.stringify(services) %>;
    const events = servicesData.map(function(s) {
        let start = s.serviceDateTime;
        if (!(typeof start === 'string' && /^\d{4}-\d{2}-\d{2}T/.test(start))) {
            try {
                start = new Date(start).toISOString();
            } catch (e) {
                start = '';
            }
        }
        return {
            title: s.topic,
            start: start,
            extendedProps: {
                _id: s._id
            }
        };
    });

    document.addEventListener('DOMContentLoaded', function() {
        const calendarEl = document.getElementById('calendar');
        const calendar = new FullCalendar.Calendar(calendarEl, {
            initialView: 'dayGridMonth',
            headerToolbar: {
                left: 'prev,next today',
                center: 'title',
                right: 'dayGridMonth,timeGridWeek'
            },
            events: events,
            eventClick: function(info) {
                window.location.href = `/services/${info.event.extendedProps._id}`;
            },
            editable: true,
            eventDrop: function(info) {
                const serviceId = info.event.extendedProps._id;
                const newDate = info.event.start;

                fetch(`/services/update-date`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ serviceId, newDate })
                })
                .then(response => response.json())
                .then(data => {
                    if (!data.success) {
                        alert('Failed to update service date.');
                        info.revert();
                    } else {
                        // Show a brief success message
                        const msg = document.createElement('div');
                        msg.textContent = 'Service date updated!';
                        msg.style.position = 'fixed';
                        msg.style.top = '20px';
                        msg.style.right = '20px';
                        msg.style.background = '#28a745';
                        msg.style.color = '#fff';
                        msg.style.padding = '10px 20px';
                        msg.style.borderRadius = '5px';
                        msg.style.zIndex = 9999;
                        document.body.appendChild(msg);
                        setTimeout(() => document.body.removeChild(msg), 1500);
                    }
                })
                .catch(err => {
                    console.error('Error updating service date:', err);
                    info.revert();
                });
            }
        });
        calendar.render();
    });
</script> 

<%- include('partials/footer') %>
